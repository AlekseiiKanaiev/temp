import React from 'react';
import styled from 'styled-components';
import InlineMessage from '@atlaskit/inline-message';

export default function IssueCardVulnerability({ issue }) {
  const ScoreWrapper = styled.span`
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto',
      'Oxygen', 'Ubuntu', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
      sans-serif;
    font-weight: 700;
    font-style: normal;
    font-size: 14px;
    line-height: 24px;
    float: right;
  `;

  const AlignWrapper = styled.span`
    vertical-align: top;
  `;

  const FontWrapper = styled.span`
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto',
      'Oxygen', 'Ubuntu', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
      sans-serif;
    font-weight: 400;
    font-style: normal;
    font-size: 14px;
    line-height: 24px;
  `;

  const TextWrapper = styled.p`
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto',
      'Oxygen', 'Ubuntu', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
      sans-serif;
    font-weight: 600;
    font-style: normal;
    font-size: 14px;
    line-height: 20px;
  `;

  const LiTextWrapper = styled.li`
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto',
      'Oxygen', 'Ubuntu', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
      sans-serif;
    font-weight: 400;
    font-style: normal;
    font-size: 14px;
    line-height: 20px;
  `;

  const LabelWithDelimiter = styled.label`
    border-left: 1px solid #ccc;
    margin-left: 5px;
    padding-left: 5px;
  `;

  const LinkWrapper = styled.a`
    color: rgb(0, 82, 204) !important;
  `;

  const vulnerability = () => {
    const items = issue.issueData.identifiers;
    if (!items) {
      return [];
    }
    const order = ['ALTERNATIVE', 'CWE', 'CVE'];
    const links = order.flatMap((type) => {
      const item = Object.keys(items).find((item) => item === type);
      if (item) {
        return items[item].map((element) => {
          let link = '';
          if (item === 'ALTERNATIVE') {
            link = `https://snyk.io/vuln/${element}`;
          }
          if (item === 'CWE') {
            link = `https://cwe.mitre.org/data/definitions/${element.substring(
              element.lastIndexOf('-') + 1,
            )}`;
          }
          if (item === 'CVE') {
            link = `https://nvd.nist.gov/vuln/detail/${element}`;
          }
          if (link) {
            return (
              <LinkWrapper href={link} target="_blank" rel="noreferrer">
                {element}
              </LinkWrapper>
            );
          }
          return undefined;
        });
      }
      return undefined;
    });

    if (issue.issueData.url) {
      links.unshift(
        <LinkWrapper
          href={issue.issueData.url}
          target="_blank"
          rel="noreferrer"
        >
          {issue.issueData.url.replace('https://snyk.io/vuln/', '')}
        </LinkWrapper>,
      );
    }
    const result = [];
    links.forEach((link) => {
      if (link) {
        result.push(link);
      }
    });
    return result;
  };

  return (
    <>
      <FontWrapper>
        VULNERABILITY
        {vulnerability().map((item) => <LabelWithDelimiter>{item}</LabelWithDelimiter>)}
      </FontWrapper>
      <ScoreWrapper>
        <AlignWrapper>{`SCORE ${issue.priority.score} `}</AlignWrapper>
        <AlignWrapper>
          <InlineMessage type="info" placement="top-end">
            <div>
              <TextWrapper>Why this priority score?</TextWrapper>
              <ul>
                {issue.priority.factors.map((factor) => (
                  <LiTextWrapper>{factor.description}</LiTextWrapper>
                ))}
              </ul>
            </div>
          </InlineMessage>
        </AlignWrapper>
      </ScoreWrapper>
    </>
  );
}
