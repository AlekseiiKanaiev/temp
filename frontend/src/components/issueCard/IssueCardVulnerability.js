import React from 'react';
import styled from 'styled-components';
import InlineMessage from '@atlaskit/inline-message';

export default function IssueCardVulnerability({ issue }) {
  const ScoreWrapper = styled.span`
    font-weight: bold;
    float: right;
  `;

  const AlignWrapper = styled.span`
    vertical-align: middle;
  `;

  const FontWrapper = styled.span`
    font-family: monospace;
    font-size: large;
  `;

  const vulnerability = () => {
    const items = issue.issueData.identifiers;
    if (!items) {
      return []
    }
    const order = ['ALTERNATIVE', 'CWE', 'CVE'];
    const links = order.flatMap((type) => {
      const item = Object.keys(items).find((item) => item === type);
      if (item) {
        return items[item].map((element) => {
          let link = '';
          if (item === 'ALTERNATIVE') {
            link = `https://snyk.io/vuln/${element}`;
          }
          if (item === 'CWE') {
            link = `https://cwe.mitre.org/data/definitions/${element.substring(
              element.lastIndexOf('-') + 1,
            )}`;
          }
          if (item === 'CVE') {
            link = `https://nvd.nist.gov/vuln/detail/${element}`;
          }
          if (link) {
            return (
              <a href={link} target="_blank" rel="noreferrer">
                {element}
              </a>
            );
          }
        });
      }
    });

    const result = [];
    links.forEach((link) => {
      if (link) {
        result.push(' | ');
        result.push(link);
      }
    });
    return result;
  };

  return (
    <>
      <FontWrapper>
        VULNERABILITY
        {vulnerability().map((item) => item)}
      </FontWrapper>
      <ScoreWrapper>
        <AlignWrapper>{`SCORE ${issue.priority.score} `}</AlignWrapper>
        <AlignWrapper>
          <InlineMessage type="info" placement="top-end">
            <div style={{ fontSize: 'smaller' }}>
              <p>Why this priority score?</p>
              <ul>
                {issue.priority.factors.map((factor) => <li>{factor.description}</li>)}
              </ul>
            </div>
          </InlineMessage>
        </AlignWrapper>
      </ScoreWrapper>
    </>
  );
}
